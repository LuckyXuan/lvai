<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<title></title>
		<script src="../../js/mui.min.js"></script>
		<link href="../../css/mui.min.css" rel="stylesheet" />
		<!--<link rel="stylesheet" type="text/css" href="../../css/header.css"/>-->
		<script type="text/javascript" src="../../js/lvai.data/config.js"></script>
		<script src="../../js/jquery-1.7.2.min.js"></script>
		<script src="../../js/jquery.lazyload.js"></script>
		<script type="text/javascript" src="../../js/lvai.base/JsonTools.js"></script>
		<script type="text/javascript" src="../../js/lvai.op/FileTool.js"></script>
		<script type="text/javascript" src="../../js/lvai.base/Utility.js"></script>
		<script type="text/javascript" src="../../js/lvai.base/localStorageUtils.js"></script>
		<script type="text/javascript" src="../../js/extends/extends.js"></script>
		<script type="text/javascript" src="../../js/lvai.data/UserDAL.js"></script>
		<script type="text/javascript" src="../../js/lvai.data/WebService2.js"></script>
		<script type="text/javascript" src="../../js/mui.zoom.js"></script>
		<script type="text/javascript" src="../../js/mui.previewimage.js"></script>
		<script type="text/javascript" src="../../js/lvai.op/HttpDownLoad.js"></script>
		<script type="text/javascript" src="../../js/extends/extends.js"></script>

		<!--相册模版-->
		<script type="text/javascript" src="../../js/lvai.data/md5.js"></script>
		<script type="text/javascript" src="../../js/lvai.base/ImgTool.js"></script>
		<script type="text/javascript" src="../../js/lvai.data/AlbumElement.js"></script>

		<style type="text/css">
			/*body{background-color: white;}
			.mui-content{background-color: white;}*/
			
			#selectMenu {
				margin-top: 12px;
			}
			#selectMenu li {
				margin-bottom: 10px;
				background: white;
			}
			#selectMenu ul {
				background-color: #EEEEEE
			}
			.mui-control-content {
				min-height: 350px;
			}
			.mui-control-content .mui-loading {
				margin-top: 50px;
			}
			.card {
				background-color: white;
			}
			/*.photoShow {} .photoShow img {
				float: left;
				margin: 10px;
				width: 100px !important;
				height: 100px !important;
			}*/
			
			.photoShow li {
				width: 33.33%;
				margin: 0px;
				padding: 0px;
			}
			.photoShow h3 {
				float: right;
				width: 20%;
				color: cornflowerblue;
				background: rgba(200, 200, 200, 0.3);
				margin-top: -23px;
			}
			.photoShow h5 {
				z-index: 10;
				margin-left: -30px;
				margin-bottom: -15px;
				color: greenyellow;
			}
			.photoShow img {
				float: right;
				width: 100px !important;
				height: 100px !important;
			}
			/*.rp {
				width: 100%;
				height: 100%;
				display: none;
				text-align: center;
				position: fixed;
				top: 0;
				background: rgba(0,0,0,0.8);
				z-index: 9999;
				overflow: hidden;
			}*/
		</style>
		<style>
			.mui-preview-image.mui-fullscreen {
				position: fixed;
				z-index: 20;
				background-color: #000;
			}
			.mui-preview-header,
			.mui-preview-footer {
				position: absolute;
				width: 100%;
				left: 0;
				z-index: 10;
			}
			.mui-preview-header {
				height: 44px;
				top: 0;
			}
			.mui-preview-footer {
				height: 50px;
				bottom: 0px;
			}
			.mui-preview-header .mui-preview-indicator {
				display: block;
				line-height: 25px;
				color: #fff;
				text-align: center;
				margin: 15px auto 4;
				width: 70px;
				background-color: rgba(0, 0, 0, 0.4);
				border-radius: 12px;
				font-size: 16px;
			}
			.mui-preview-image {
				display: none;
				-webkit-animation-duration: 0.5s;
				animation-duration: 0.5s;
				-webkit-animation-fill-mode: both;
				animation-fill-mode: both;
			}
			.mui-preview-image.mui-preview-in {
				-webkit-animation-name: fadeIn;
				animation-name: fadeIn;
			}
			.mui-preview-image.mui-preview-out {
				background: none;
				-webkit-animation-name: fadeOut;
				animation-name: fadeOut;
			}
			.mui-preview-image.mui-preview-out .mui-preview-header,
			.mui-preview-image.mui-preview-out .mui-preview-footer {
				display: none;
			}
			.mui-zoom-scroller {
				position: absolute;
				display: -webkit-box;
				display: -webkit-flex;
				display: flex;
				-webkit-box-align: center;
				-webkit-align-items: center;
				align-items: center;
				-webkit-box-pack: center;
				-webkit-justify-content: center;
				justify-content: center;
				left: 0;
				right: 0;
				bottom: 0;
				top: 0;
				width: 100%;
				height: 100%;
				margin: 0;
				-webkit-backface-visibility: hidden;
			}
			.mui-zoom {
				-webkit-transform-style: preserve-3d;
				transform-style: preserve-3d;
			}
			.mui-slider .mui-slider-group .mui-slider-item img {
				width: auto;
				height: auto;
				max-width: 100%;
				max-height: 100%;
			}
			.mui-android-4-1 .mui-slider .mui-slider-group .mui-slider-item img {
				width: 100%;
			}
			.mui-android-4-1 .mui-slider.mui-preview-image .mui-slider-group .mui-slider-item {
				display: inline-table;
			}
			.mui-android-4-1 .mui-slider.mui-preview-image .mui-zoom-scroller img {
				display: table-cell;
				vertical-align: middle;
			}
			.mui-preview-loading {
				position: absolute;
				width: 100%;
				height: 100%;
				top: 0;
				left: 0;
				display: none;
			}
			.mui-preview-loading.mui-active {
				display: block;
			}
			.mui-preview-loading .mui-spinner-white {
				position: absolute;
				top: 50%;
				left: 50%;
				margin-left: -25px;
				margin-top: -25px;
				height: 50px;
				width: 50px;
			}
			.mui-preview-image img.mui-transitioning {
				-webkit-transition: -webkit-transform 0.5s ease, opacity 0.5s ease;
				transition: transform 0.5s ease, opacity 0.5s ease;
			}
			@-webkit-keyframes fadeIn {
				0% {
					opacity: 0;
				}
				100% {
					opacity: 1;
				}
			}
			@keyframes fadeIn {
				0% {
					opacity: 0;
				}
				100% {
					opacity: 1;
				}
			}
			@-webkit-keyframes fadeOut {
				0% {
					opacity: 1;
				}
				100% {
					opacity: 0;
				}
			}
			@keyframes fadeOut {
				0% {
					opacity: 1;
				}
				100% {
					opacity: 0;
				}
			}
			p img {
				max-width: 100%;
				height: auto;
			}
		</style>
		<script type="text/javascript" charset="utf-8">
			var wt; //等待对象
			 //页面对象
			var listCar;
			var listCarWidth;
			 //车辆对象
			var carPhoto = new Array(); //车辆地址存放
			var photoindex = 0;
			 //子页面等对象
			var editor;
			var ed_car;
			var ed_video;
			var ed_job;
			 //文件下载对象。
			var fileDownLoad;
			var headPhotoFileInfoIsLoad = false,
				carFileInfoIsLoad = false,
				userPhotoBgFileInfoIsLoad = false,
				userAudioFileInfoIsLoad = false,
				albumInfoIsLoad = true,
				albumIsShow = false;
			 //个人中心各个对象
			var userInfo = null,
				carInfo = null,
				userAudio = null,
				userVideo = null,
				albumInfo = null;
			 //音频设备对象
			var record = null, //录音对象
				t = null,
				iv = null,
				w = null,
				playAudio = null, //播放对象
				playAudioUrl = null;
			/*MUI页面初始化*/
			mui.init({
				gestureConfig: {
					hold: true, //默认为false，不监听
					longtap: true, //默认为false
					release: true //默认为false，不监听
				}
			});
			 // 扩展API加载完毕后调用onPlusReady回调函数 
			document.addEventListener("plusready", onPlusReady);
			 // 应用程序入口。
			function onPlusReady() {
				/*页面初始化，加载页面元素*/
				pageInit();
				/*页面加载完成发生*/
				pageOnload();
				/*页面渲染*/
				PageRender();
				//请求网络数据以便判断一致性并渲染文字资料
				getNetData();
			};
			/**
			 * 页面初始化函数，加载HTML，但是不加载数据。
			 * 加载菜单。
			 * 预加载子页面。
			 */
			function pageInit() {
				fileDownLoad = new HttpDownLoad();
				fileDownLoad.StartDownLoadHandler = function() {
					if (fileDownLoad.FileList().length == 0) return;
					wt = plus.nativeUI.showWaiting("拼命加载中...");
				}
				fileDownLoad.DownLoadComleteHandler = function() {
					wt.close();
					//当下载的内容子页面需要引用时必须更改子页面
					mui.fire(plus.webview.getWebviewById("ed_car"), "page:change");
					//显示下载的图片资源。
					RenderData();
				}
				listCarWidth = plus.webview.currentWebview().listCarWidth;
				new localStorageUtils().setItem("HeadPhotoBase64", "");
				systemUi();
				CarPhotoUi();
				OnPreload();
				MenuInit();
				webListener();
			};
			 //页面加载完成发生。
			function pageOnload() {
				//加载本地用户数据。（以便获取网络数据时提供手机号）
				LoadUserInfo();
				LoadCarInfo();
				LoadUserAudio();
				LoadUserVideo();
				LoadAlbumInfo();
			};
			 //页面渲染
			function PageRender() {
				renderUserInfoData();
				renderHeadPhoto();
				renderUserPhotoBg();
				renderCarInfo();
				renderCarPhoto();
				renderUserAudio();
				renderUserVideo();
				//renderAlbumInfo();
			};
			 //获取网络数据（只包括资料页面）
			function getNetData() {
				//网络数据是否加载完毕的标识（图片,视频，音频的请求）
				var IsGetNetDataOver = 2;
				//获取车辆信息本地化。。并渲染初步数据
				new UserDAL().getCarInfo(userInfo.user_telphone, function() {
					LoadCarInfo();
					renderCarInfo();
					IsGetNetDataOver--;
					if (IsGetNetDataOver == 0) {
						LoadData();
					}
				}, function() {
					mui.toast("车辆信息获取失败！");
					IsGetNetDataOver--;
					if (IsGetNetDataOver == 0) {
						LoadData();
					}
				});
				//获取音频信息
				new UserDAL().getUserAudio(userInfo.user_telphone, function() {
					LoadUserAudio();
					//修改审核状态
					document.querySelector("#recordShow > span").innerHTML = userAudio.audio_state;
					//renderUserAudio();
					IsGetNetDataOver--;
					if (IsGetNetDataOver == 0) {
						LoadData();
					}
				}, function() {
					mui.toast("音频信息获取失败！");
					IsGetNetDataOver--;
					if (IsGetNetDataOver == 0) {
						LoadData();
					}
				});
				//获取视频信息
				new UserDAL().getUserVideo(userInfo.user_telphone, function() {
					LoadUserVideo();
					//修改审核状态
					document.querySelector("#VideoShow > span").innerHTML = userVideo.video_state;
					renderUserVideo();
				}, function() {
					mui.toast("视频信息获取失败！");
				});
				//获取礼物
				//获取其他
			};
			 //数据展示（主要涉及图片）
			function LoadData() {
				loadUserHeadPhoto();
				loadUserPhotoBgNetData();
				loadCarPhotoNetData();
				loadUserAudioNetData();
				//loadAlbumData();
			};
			/**
			 * 呈现网络数据
			 */
			function RenderData() {
				renderHeadPhoto();
				renderUserPhotoBg();
				renderCarPhoto();
				renderUserAudio();
				//renderAlbumInfo();
			};
			/***
			 * 载入本页面相关网络资源。
			 * 如果已经缓存在本地则不加载网络资源。
			 * 否则加载网络资源。
			 */
			function LoadResource() {
				fileDownLoad.DownLoad();
			};
			/*************************加载本地数据******************************************/
			 //加载本地化的用户基本信息对象
			function LoadUserInfo() {
				userInfo = new UserDAL().getUserInfo();
			};
			 //加载本地化的用户车辆对象
			function LoadCarInfo() {
				carInfo = new UserDAL().getUserCar();
			};
			 //加载本地化的用户音频对象
			function LoadUserAudio() {
				var user_Audio = new localStorageUtils().getItem("userAudio");
				if (user_Audio) {
					userAudio = new JsonTools().stringToJson(user_Audio);
				} else {
					userAudio = null;
				}
			};

			function LoadUserVideo() {
					var user_Video = new localStorageUtils().getItem("userVideo");
					if (user_Video) {
						userVideo = new JsonTools().stringToJson(user_Video);
						console.log(user_Video);
					} else {
						userVideo = null;
					}
				}
				//加载本地化的用户相册对象

			function LoadAlbumInfo() {
				var ab = new localStorageUtils().getItem("Album");
				if (ab) {
					albumInfo = new JsonTools().stringToJson(ab);
				}
			};
			/*************************呈现基础数据******************************************/
			 //呈现用户基础信息。
			function renderUserInfoData() {
				//找到登录时   在服务器  获取到的 用户信息
				document.querySelector("#txtName").innerHTML = !userInfo.user_nikeName ? "昵称：未填" : userInfo.user_nikeName;
				document.querySelector("#user_height").innerHTML = !userInfo.user_height ? "身高：未填" : userInfo.user_height;
				document.querySelector("#user_weight").innerHTML = !userInfo.user_weight ? "体重：未填" : userInfo.user_weight;
				document.querySelector("#user_income").innerHTML = !userInfo.user_income ? "收入：未填" : userInfo.user_income;
				document.querySelector("#user_address").innerHTML = !userInfo.user_address ? "地址：未填" : userInfo.user_address;
				document.querySelector("#user_job").innerHTML = !userInfo.user_job ? "工作：未填" : userInfo.user_job;
				if (!userInfo.user_birthday) {
					document.querySelector("#user_age").innerHTML = "年龄：未填"
				} else {
					var Newtime = new Date();
					document.querySelector("#user_age").innerHTML = Newtime.getFullYear() - new Date(userInfo.user_birthday).getFullYear() + 1 + "岁";
				}
			};
			 //呈现用户头像。
			function renderHeadPhoto() {
				if (userInfo.user_photo == "") return;
				var url = "_doc/HeadPhoto/" + userInfo.user_photo.substring(userInfo.user_photo.lastIndexOf('/') + 1);
				fileTool.fileExist(url, userInfo.user_photo,
					function(msg) {
						document.querySelector("#editor").setAttribute("src", plus.io.convertLocalFileSystemURL(msg));
					},
					function(msg, _args) {}
				);
			};
			 //呈现用户背景
			function renderUserPhotoBg() {
				if (userInfo.personcenter_bg == "") return;
				var url = "_doc/BGPhoto/" + userInfo.personcenter_bg.substring(userInfo.personcenter_bg.lastIndexOf('/') + 1);
				fileTool.fileExist(url, userInfo.personcenter_bg,
					function(msg) {
						document.querySelector("#backImg").style.background = "url(file://" + plus.io.convertLocalFileSystemURL(msg) + ") no-repeat center center";
						document.querySelector("#backImg").style.backgroundSize = "100%";
					},
					function(msg, _args) {}
				);
			};
			 //呈现车辆基本资料
			function renderCarInfo() {
				if (!carInfo) {
					return;
				}
				if (carInfo.car_brand) {
					document.querySelector("#car_brand").innerHTML = carInfo.car_brand;
				}
				if (carInfo.car_level) {
					document.querySelector("#car_level").innerHTML = carInfo.car_level;
				}
				if (carInfo.car_type) {
					document.querySelector("#car_type").innerHTML = carInfo.car_type;
				}
				carPhoto[0] = carInfo.car_photo1;
				carPhoto[1] = carInfo.car_photo2;
				carPhoto[2] = carInfo.car_photo3;
			};
			 //呈现车辆靓照
			function renderCarPhoto() {
				if (!carInfo) {
					return;
				}
				for (var index = 0; index < carPhoto.length; index++) {
					if (carPhoto[index]) {
						listCar.style.height = listCarWidth * 0.3 + 6 + "px";
						var url = "_doc/CarPhoto/thumbCarPhoto/" + carPhoto[index].substring(carPhoto[index].lastIndexOf('/') + 1);
						var carPhotoImg = listCar.getElementsByTagName('img');
						carPhotoImg[index].setAttribute("src", plus.io.convertLocalFileSystemURL(url));
						carPhotoImg[index].style.display = "block";
					}
				}
			};
			 //呈现音频
			function renderUserAudio() {
				if (!userAudio || userAudio.audio_url == "") {
					return;
				}
				//修改播放的事件--改变播放的地址
				playAudioUrl = "_doc/audio/" + userAudio.audio_url.substring(userAudio.audio_url.lastIndexOf('/') + 1);
				//当有音频则可看
				document.querySelector("#recordShow").style.visibility = "visible";
			};

			function renderUserVideo() {
					if (!userVideo || userVideo.video_url == "") {
						return;
					}
					//当有视频则可看
					document.querySelector("#VideoShow").style.visibility = "visible";
				}
				/*************************加载各个部位的网络资源列表****************************/
				//从网络载入头像图片

			function loadUserHeadPhoto() {
				if (userInfo.user_photo == "") {
					headPhotoFileInfoIsLoad = true;
					FileIsOk();
				} else {
					var url = "_doc/HeadPhoto/" + userInfo.user_photo.substring(userInfo.user_photo.lastIndexOf('/') + 1);
					fileTool.fileExist(url, userInfo.user_photo,
						function(msg) {
							headPhotoFileInfoIsLoad = true;
							FileIsOk();
						},
						function(msg, _args) {
							var f = new HttpFile();
							f.FileName = userInfo.user_photo.substring(userInfo.user_photo.lastIndexOf('/') + 1);
							f.FilePath = "_doc/HeadPhoto/";
							f.URL = ResourcesServerUrl + userInfo.user_photo;
							fileDownLoad.AddFile(f);
							headPhotoFileInfoIsLoad = true;
							FileIsOk();
						}
					);
				}
			};
			 //从网络载入头像区域的背景图片
			function loadUserPhotoBgNetData() {
				if (userInfo.personcenter_bg == "") {
					userPhotoBgFileInfoIsLoad = true;
					FileIsOk();
				} else {
					var url = "_doc/BGPhoto/" + userInfo.personcenter_bg.substring(userInfo.personcenter_bg.lastIndexOf('/') + 1);
					fileTool.fileExist(url, userInfo.personcenter_bg,
						function(msg) {
							userPhotoBgFileInfoIsLoad = true;
							FileIsOk();
						},
						function(msg, _args) {
							var f = new HttpFile();
							f.FileName = userInfo.personcenter_bg.substring(userInfo.personcenter_bg.lastIndexOf('/') + 1);
							f.FilePath = "_doc/BGPhoto/";
							f.URL = ResourcesServerUrl + userInfo.personcenter_bg;
							fileDownLoad.AddFile(f);
							userPhotoBgFileInfoIsLoad = true;
							FileIsOk();
						}
					);
				}
			};
			 //从网络载入车辆图片
			function loadCarPhotoNetData() {
				if (!carInfo) {
					carFileInfoIsLoad = true;
					FileIsOk();
				} else {
					photoindex = 0;
					for (var index = 0; index < carPhoto.length; index++) {
						if (!carPhoto[index]) {
							photoindex++;
							if (photoindex == 3) {
								carFileInfoIsLoad = true;
								FileIsOk();
							}
							continue;
						}
						var url = "_doc/CarPhoto/thumbCarPhoto/" + carPhoto[index].substring(carPhoto[index].lastIndexOf('/') + 1);
						fileTool.fileExist(url, carPhoto[index], function(msg) {
							photoindex++;
							if (photoindex == carPhoto.length) {
								carFileInfoIsLoad = true;
								FileIsOk();
							}
						}, function(path, serverPath) {
							var f = new HttpFile();
							f.FileName = serverPath.substring(serverPath.lastIndexOf('/') + 1);
							f.FilePath = "_doc/CarPhoto/thumbCarPhoto/";
							f.URL = ResourcesServerUrl + serverPath;
							fileDownLoad.AddFile(f);
							photoindex++;
							if (photoindex == carPhoto.length) {
								carFileInfoIsLoad = true;
								FileIsOk();
							}
						});
					}
				}
			};

			function loadUserAudioNetData() {
				if (!userAudio || !userAudio.audio_url) {
					userAudioFileInfoIsLoad = true;
					FileIsOk();
					return;
				}
				var url = "_doc/audio/" + userAudio.audio_url.substring(userAudio.audio_url.lastIndexOf('/') + 1);
				fileTool.fileExist(url, userAudio.audio_url, function(msg) {
					userAudioFileInfoIsLoad = true;
					FileIsOk();
				}, function(path, serverPath) {
					var f = new HttpFile();
					f.FileName = serverPath.substring(serverPath.lastIndexOf('/') + 1);
					f.FilePath = "_doc/audio/";
					f.URL = ResourcesServerUrl + serverPath;
					fileDownLoad.AddFile(f);
					userAudioFileInfoIsLoad = true;
					FileIsOk();
				});
			};
			 //下载列表是否全部加载
			function FileIsOk() {
				if (headPhotoFileInfoIsLoad && carFileInfoIsLoad && userPhotoBgFileInfoIsLoad && userAudioFileInfoIsLoad) {
					LoadResource();
				}
			};
			/*************************相册****************************/
			 //获取网络上的相册文件
			function loadAlbumData() {
				new UserDAL().getUserAlbumInfo(userInfo.user_telphone, function(_msg) {
					new localStorageUtils().setItem("Album", new JsonTools().jsonObjToString(_msg));
					console.log("获取到album数据");
					LoadAlbumInfo();
					renderAlbumInfo();
				}, function(_msg) {
					mui.toast("获取相册数据失败");
				});
			};
			 //显示本地相册数据
			function renderAlbumInfo() {
				console.log("展示本地相册");
				console.log(albumInfo);
				var d = new Date();
				var album, imgs, time, paths;
				for (var i in albumInfo) {
					album = albumInfo[i];
					imgs = "";
					time = "";
					paths = "";
					for (var j in album.PhotoList) {
						paths = album.PhotoList[j].personphoto_path;
						//paths = paths.substring(paths.lastIndexOf('/') + 1);
						imgs = imgs + paths + "|";
					}
					imgs = imgs.substring(0, imgs.length - 1);
					d.setCsharpTime(album.album_time);
					time = d.toFormatString('yyyy-MM-dd');
					AddAlbum(album.album_id, imgs, time);
				}
			};
			 //本地页面添加相册
			function AddAlbum(_id, _imgs, _time) {
				if (document.getElementById("Album_" + _id)) {
					//如果有就不创建
					return;
				}
				var abLi = null;
				var abRoom = document.getElementById("AlbumRoom");
				var ab = new albumElement();
				ab.id = _id;
				ab.imgs = _imgs.split('|');
				ab.time = _time;
				ab.initAlbumObj();
				ab.setFun('tap', function() {
					//alert(this.id); 
					// 封面tap事件
				});
				ab.setFun('longtap', function() {
					var that = this;
					plus.nativeUI.confirm('是否删除相册？', function(e) {
						switch (e.index) {
							case 0: //确认
								//1，向服务器发起  删除相册请求      Album.id为标识符
								//2成功回调 就删除本地
								var album_id = that.id.substring(that.id.lastIndexOf('_') + 1);
								var deleteW = plus.nativeUI.showWaiting("正在删除中...");
								new UserDAL().deleteAlbum(userInfo.user_telphone, album_id, function(_msg) {
									abRoom.removeChild(that);
									deleteW.close();
									mui.toast("删除相册文件夹成功！");
								}, function(e) {
									mui.toast("删除失败！");
									deleteW.close();
									console.log(e.msg);
								});
								break;
							case 1: //取消
								break;
							default:
								break;
						}
					}, "警告", ["确认", "取消"]);
				});
				abRoom.appendChild(ab.getAlbumLiNode());
			};
			/*************************页面初始化****************************/
			 // 系统Ui
			function systemUi() {
				//减速系数
				mui('.mui-scroll-wrapper').scroll({
					//deceleration: 0.0001, //减速系数，系数越大，滚动速度越慢，滚动距离越小，默认值0.0006
					deceleration: 0.002,
					indicators: false
				});
			};
			 //车辆图片Ui
			function CarPhotoUi() {
				listCar = document.querySelector("#loveCarPhoto");
				var carPhotoImg = listCar.getElementsByTagName('img');
				for (var car_index = 0; car_index < carPhotoImg.length; car_index++) {
					carPhotoImg[car_index].style.width = listCarWidth * 0.3 + "px";
					carPhotoImg[car_index].style.height = listCarWidth * 0.3 + "px";
					carPhotoImg[car_index].style.margin = "3px 6px";
					carPhotoImg[car_index].className = "lazy";
					carPhotoImg[car_index].style.float = "left";
					carPhotoImg[car_index].style.display = "none";
				}
			};
			 //预加载
			function OnPreload() {
				editor = mui.preload({
					"id": 'editor',
					"url": 'editor_card1.html'
				});
				ed_car = mui.preload({
					"id": 'ed_car',
					"url": 'editor_car.html'
				});
				ed_video = mui.preload({
					"id": 'ed_video',
					"url": 'editor_video.html'
				});
				ed_job = mui.preload({
					"id": 'ed_job',
					"url": 'editor_job.html'
				});
			};
			 //按钮的监听事件
			function MenuInit() {
				//照片选项栏选中事件
				document.querySelector('.mui-slider').addEventListener('slide', function(event) {
					mui('.mui-scroll-wrapper').scroll().scrollTo(0, 0, 100);
					switch (event.detail.slideNumber) {
						case 0:
							break;
						case 1:
							if (!albumIsShow) {
								//显示本地
								renderAlbumInfo();
								//获取网络
								loadAlbumData();
								albumIsShow = true; //已经加载了，不在重复加载
							}
							break;
						case 2:
							break;
					}
				});
				//背景按钮
				document.getElementById("backImg").addEventListener('tap', function() {
					var this_backImg = this;
					var btnArray = [{
						title: "预览原图"
					}, {
						title: "更改背景图"
					}];
					plus.nativeUI.actionSheet({
						//title: "头像选取方式",  
						cancel: "取消",
						buttons: btnArray
					}, function(e) {
						var index = e.index;
						switch (index) {
							case 0:
								{
									//取消 
									break;
								}
							case 1:
								{
									//预览原图
									break;
								}
							case 2:
								{
									console.log(this_backImg.style.background);
									//选取现有的
									plus.gallery.pick(function(path) {
											var savePath = "_doc/BGPhoto/" + userInfo.user_telphone + "_bg_" + new Date().toFormatString("yyyyMMddhhmmss") + ".png";
											fileTool.ImgFileCompress(path, savePath, "30%", function(existPath, savePath) {
												this_backImg.style.background = "url(file://" + plus.io.convertLocalFileSystemURL(savePath) + ") no-repeat center center";
												this_backImg.style.backgroundSize = "100%";
												var files = [];
												files[0] = {
													name: plus.io.convertLocalFileSystemURL(savePath),
													path: plus.io.convertLocalFileSystemURL(savePath)
												};
												new UserDAL().uploadBgPhoto(userInfo.user_telphone, files, function(_msg, fileName) {
													console.log(_msg);
													userInfo.personcenter_bg = "/UploadFile/UserCenterBg/" + fileName.substring(fileName.lastIndexOf('/') + 1);
													new localStorageUtils().setItem("userInfo", new JsonTools().jsonObjToString(userInfo));
												}, function(_msg) {
													mui.toast("背景同步失败");
												});
											}, function(_msg) {
												mui.toast("图片文件出错,请重新选择");
											});
										},
										function(e) {}, {
											filter: "image"
										});
									break;
								}
						}
					});
				});
				//头像按钮
				document.getElementById('editor').addEventListener('tap', function(e) {
					e.stopPropagation();
					var btnArray = [{
						title: "拍照"
					}, {
						title: "选取现有的"
					}];
					plus.nativeUI.actionSheet({
						//title: "头像选取方式",  
						cancel: "取消",
						buttons: btnArray
					}, function(e) {
						var index = e.index;
						switch (index) {
							case 0:
								{
									//plus.ui.alert("你选择了取消", "警告", "OK");
									break;
								}
							case 1:
								{
									//plus.ui.alert("你选择了拍照", "警告", "OK");							
									var cmr = plus.camera.getCamera();
									var res = cmr.supportedImageResolutions[0];
									var fmt = cmr.supportedImageFormats[0];
									cmr.captureImage(function(path) {
											//alert(plus.io.convertLocalFileSystemURL(path));
											plus.storage.setItem("Icon", plus.io.convertLocalFileSystemURL(path));
											console.log(plus.storage.getItem("Icon"));
											var wvphone = mui.openWindow({
												url: 'editor_photo.html',
												id: 'Icon',
												show: {
													aniShow: 'fade-in'
												}
											});
											wvphone.addEventListener("close", function() {
												console.log("裁剪窗口以关闭");
												var base64 = new localStorageUtils().getItem("HeadPhotoBase64");
												if (base64 != "") {
													document.querySelector("#editor").setAttribute("src", base64);
												}
											});
											//document.querySelector("#user_photo>img").setAttribute('src', plus.io.convertLocalFileSystemURL(path));
										},
										function(error) {
											alert("Capture image failed: " + error.message);
										}, {
											resolution: res,
											format: fmt
										}
									);
									break;
								}
							case 2:
								{
									//plus.ui.alert("你选择了选取现有的", "警告", "OK");	
									plus.gallery.pick(function(path) {
										plus.storage.setItem("Icon", plus.io.convertLocalFileSystemURL(path));
										console.log(plus.storage.getItem("Icon"));
										var wvphone = mui.openWindow({
											url: 'editor_photo.html',
											id: 'Icon',
											show: {
												aniShow: 'fade-in'
											}
										});
										wvphone.addEventListener("close", function() {
											console.log("裁剪窗口以关闭");
											var base64 = new localStorageUtils().getItem("HeadPhotoBase64");
											if (base64 != "") {
												document.querySelector("#editor").setAttribute("src", base64);
											}
										});
									}, function(e) {}, {
										filter: "image"
									});
									break;
								}
						}
					});
				});
				//基本信息按钮
				document.getElementById('ed').addEventListener('tap', function() {
					mui.fire(editor, 'show', null);
					setTimeout(function() {
						mui.openWindow({
							id: 'editor',
							show: {
								aniShow: 'pop-in'
							},
							waiting: {
								autoShow: false
							},
							styles: {
								zindex: 600
							}
						});
					}, 0);
				});
				//车辆信息按钮
				document.getElementById("ed_car").addEventListener('tap', function() {
					mui.fire(ed_car, 'show', null);
					setTimeout(function() {
						mui.openWindow({
							id: 'ed_car',
							show: {
								aniShow: 'zoom-fade-out',
								duration: 300
							},
							waiting: {
								autoShow: false
							},
							styles: {
								zindex: 600
							}
						});
					}, 0);
				}); //录制语音hold
				//音频
				document.getElementById("recording").addEventListener('tap', function() {
					record = plus.audio.getRecorder();
					if (record == null) {
						alert("麦克风未就绪！");
						return;
					}
					var thisr = this;
					//保存到本地的文件名
					var filename = "_doc/audio/" + userInfo.user_telphone + "_audio_" + new Date().toFormatString("yyyyMMddhhmmss") + ".amr";
					record.record({
						filename: filename
					}, function(p) {
						plus.io.resolveLocalFileSystemURL(p, function(entry) {
							var confirm = function() {
								// 弹出提示信息对话框	entry.name
								plus.nativeUI.confirm(entry.name, function(e) {
									switch (e.index) {
										case 0:
											var ww = plus.nativeUI.showWaiting("上传中... ", {
												back: "none"
											});
											var files = [];
											files[0] = {
												name: plus.io.convertLocalFileSystemURL(p),
												path: plus.io.convertLocalFileSystemURL(p)
											};
											new UserDAL().uploadUserAudio(userInfo.user_telphone, files, function(_msg) {
												var AudioTemp = {
													audio_url: "/UploadFile/UserAudio/" + files[0].name.substring(files[0].name.lastIndexOf('/') + 1),
													audio_state: "未审核"
												};
												new localStorageUtils().setItem("userAudio", new JsonTools().jsonObjToString(AudioTemp));
												ww.close();
												mui.toast("上传成功");
												LoadUserAudio();
												renderUserAudio();
											}, function(_msg) {
												ww.close();
												mui.toast("上传失败，请检查网络");
											});
											break; //上传
										case 1:
											break; //取消
										case 2:
											var ww = plus.nativeUI.showWaiting("试听中... ", {
												background: "rgba(56,12,92,0.8)",
												back: "none"
											});
											var play = plus.audio.createPlayer(p);
											play.play(function() {
												confirm();
												ww.close();
											});
											break;
											//									default:mui.toast("fail");break;
									}
								}, "是否上传该录音?", ["上传", "取消", "试听"]);
							}
							confirm();
						}, function(e) {
							mui.toast("读取录音文件错误");
						});
					}, function(e) {
						mui.toast("录音失败");
					});
					w = plus.nativeUI.showWaiting("开始录制 ", {
						padding: '6%',
						background: "rgba(10,92,19,0.7)",
						back: "none"
					});
					t = 0;
					iv = setInterval(function() {
						t++;
						if (t >= 5) {
							//							mui.trigger(thisr,'release');
							w.close();
							clearInterval(iv);
							record.stop();
							return;
						}
						w.setTitle("剩余:" + (5 - t) + "秒");
					}, 1000);
				});
				//视屏认证按钮
				document.getElementById("ed_video").addEventListener('tap', function() {
					var ps = "请控制录制时间在15s内,提高审核效率.";
					plus.nativeUI.confirm(ps, function(e) {
						switch (e.index) {
							case 0:
								var cmr = plus.camera.getCamera();
								var res = cmr.supportedVideoResolutions[3];
								var fmt = cmr.supportedVideoFormats[0];
								var fn = "_doc/Video/" + userInfo.user_telphone + "_video_" + new Date().toFormatString("yyyyMMddhhmmss") + ".mp4";
								cmr.startVideoCapture(function(path) {
										console.log(path);
										var ww = plus.nativeUI.showWaiting("视频上传中...", {
											back: "none"
										});
										var files = [];
										files[0] = {
											name: plus.io.convertLocalFileSystemURL(path),
											path: plus.io.convertLocalFileSystemURL(path)
										};
										new UserDAL().uploadVideo(ww, userInfo.user_telphone, files, function() {
											var VideoTemp = {
												video_url: "/UploadFile/UserVideo/" + files[0].name.substring(files[0].name.lastIndexOf('/') + 1),
												video_state: "未审核"
											};
											new localStorageUtils().setItem("userVideo", new JsonTools().jsonObjToString(VideoTemp));
											mui.toast("上传成功");
											LoadUserVideo();
											renderUserVideo();
											ww.close();
										}, function() {
											ww.close();
											mui.toast("上传失败，请检查网络");
										});
									},
									function(error) {
										console.log("Capture video failed: " + error.message);
									}, {
										filename: fn,
										resolution: res,
										format: fmt,
										index: '2'
									}
								);
								break;
							case 1:
							default:
								return;
						}
					}, "提示", ["开始录制", "取消"]);
				});
				//职业认证
				document.getElementById("ed_job").addEventListener('tap', function() {
					mui.fire(ed_video, 'show', null);
					setTimeout(function() {
						mui.openWindow({
							id: 'ed_job',
							show: {
								aniShow: 'pop-in'
							},
							waiting: {
								autoShow: false
							},
							styles: {
								zindex: 600
							}
						});
					}, 0);
				});
				//上传新照片 按钮
				document.getElementById("upLoadImg").addEventListener('tap', function() {
					plus.gallery.pick(function(e) {
						var files = [];
						var filenames = "";
						var w;
						var l = e.files.length;
						if (e.files.length > 9) {
							l = 9; //如果选择的超过9张，就截取前9张
						}
						w = plus.nativeUI.showWaiting("正在上传" + l + "张图片");
						for (var i = 0; i < l; i++) {
							var path = plus.io.convertLocalFileSystemURL(e.files[i]);
							var savePath = "_doc/UserAlbum/" + userInfo.user_telphone + "_" + new Date().toFormatString("yyyyMMddhhmmss") + "_" + i + ".png";
							fileTool.ImgFileCompress(path, savePath, "30%", function(existPath, savePath) {
								files.push({
									name: savePath,
									path: savePath
								});
								var fileName = savePath.substring(savePath.lastIndexOf('/') + 1);
								filenames = filenames + fileName + "|";
								if (files.length == l) {
									console.log("图片全部处理完成");
									filenames = filenames.substring(0, filenames.length - 1);
									//个人相册上传接口
									new UserDAL().uploadAlbum(userInfo.user_telphone, files, filenames, function(_msg, sysfilenames) {
										if (_msg.Status != "faild") {
											mui.toast("上传成功！");
											var ps = plus.nativeUI.showWaiting("正在更新相册...");
											new UserDAL().getUserAlbumInfo(userInfo.user_telphone, function(_msg) {
												new localStorageUtils().setItem("Album", new JsonTools().jsonObjToString(_msg));
												LoadAlbumInfo();
												renderAlbumInfo();
												ps.close();
											}, function(_msg) {
												ps.close();
												mui.toast(_msg);
											});
										} else {
											mui.toast("上传失败！");
										}
										w.close();
									}, function() {
										w.close();
										mui.toast("服务器未响应！");
									});
								}
							}, function() {
								mui.toast("第" + (i + 1) + "张图片读取出错");
								l--;
							});
						}
					}, function(e) {}, {
						filter: "image",
						multiple: true //可选择是否多张图片选择
					});
					mui.toast("您最多一次可以选择上传9张图片");
				});
				//播放音频
				document.querySelector("#recordShow button").addEventListener('tap', function() {
					playAudio = plus.audio.createPlayer(playAudioUrl);
					playAudio.play(function() {}, function(e) {
						alert("音频错误: " + e.message);
					});
				});
				//播放视频
				document.querySelector("#VideoShow button").addEventListener('tap', function() {
					var urls = ResourcesServerUrl + userVideo.video_url;
					console.log(urls);
					var Intent = plus.android.importClass("android.content.Intent");
					var Uri = plus.android.importClass("android.net.Uri");
					var main = plus.android.runtimeMainActivity();
					var intent = new Intent(Intent.ACTION_VIEW);
					var uri = Uri.parse(urls);
					intent.setDataAndType(uri, "video/*");
					main.startActivity(intent);
				});
			};
			 //webview的监听
			function webListener() {
				plus.webview.getWebviewById("editor").addEventListener("hide", function() {
					console.log("个人资料编辑窗口以关闭");
					LoadUserInfo();
					renderUserInfoData();
				});
				plus.webview.getWebviewById("ed_car").addEventListener("hide", function() {
					console.log("车辆编辑窗口以关闭");
					LoadCarInfo();
					renderCarInfo();
					renderCarPhoto();
				});
			};
		</script>
	</head>

	<body>
		<header class="mui-bar mui-bar-nav" style="display: none;">
			<h1 class="mui-title">乐小姐</h1>
		</header>
		<div class="mui-content">
			<div id="scroll" class="mui-scroll-wrapper">
				<div class="mui-scroll">
					<div id="backImg" style="  text-align: center;  padding-bottom: 30px; background: url(../../img/reg_Log.jpg) no-repeat center center;">
						<div style="height: 44px; ">
							<span style="text-align: center;line-height: 44px;">个人中心</span>
						</div>
						<img id="editor" class="lazy" style=" line-height: 50px; background-color: transparent; border: 1px solid #ddd;
  border-radius: 50px;" src="../../img/head.png" width="70px" height="70px" />
						<div>
							<span id="txtName">昵称：未填</span>
							<div style="margin-top: 10px;">
								<img src="../../img/guide_1.jpg" width="15px" height="15px" />
								<img src="../../img/guide_1.jpg" width="15px" height="15px" />
								<img src="../../img/guide_1.jpg" width="15px" height="15px" />
								<img src="../../img/guide_1.jpg" width="15px" height="15px" />
								<img src="../../img/guide_1.jpg" width="15px" height="15px" />
								<img src="../../img/guide_1.jpg" width="15px" height="15px" />
							</div>
						</div>
					</div>
					<div id="slider" class="mui-slider">
						<div id="sliderSegmentedControl" class="mui-slider-indicator mui-segmented-control mui-segmented-control-inverted" style="background-color: transparent !important;">
							<a class="mui-control-item" href="#item1mobile">
						资料 
					</a>
							<a class="mui-control-item" href="#item2mobile">
						照片
					</a>
							<a class="mui-control-item" href="#item3mobile">
						旅行
					</a>
						</div>
						<div id="sliderProgressBar" class="mui-slider-progress-bar mui-col-xs-4"></div>
						<div class="mui-slider-group">
							<div id="item1mobile" style="background-color:gainsboro" class="mui-slider-item mui-control-content mui-active">
								<div>
									<span id='ed' class="mui-icon mui-icon-compose mui-pull-right" style="line-height:12px;padding: 1px; margin-right: 8px;"></span>
									<h5 class="mui-content-padded">基本信息</h5>
									<div class="card">
										<div id="userInfoDiv" style="background: white; text-align: center; visibility:visible ; ">
											<span id="user_age">年龄：未填</span>|
											<span id="user_height">身高：未填</span>|
											<span id="user_weight">体重：未填</span>|
											<span id="user_income">收入：未填</span>|
											<br />
											<span id="user_address">地址：未填</span>|
											<span>单身</span>|
											<span id="user_job">工作：未填</span>
										</div>
									</div>
								</div>
								<div>
									<span id='ed_car' class="mui-icon mui-icon-compose mui-pull-right" style=" line-height:12px; padding: 1px;margin-right: 8px;"></span>
									<h5 class="mui-content-padded">车辆信息</h5>
									<div class="card">
										<div style="background: white; text-align: center;">
											<span id="car_brand">车辆：未填</span>|
											<span id="car_type">级别：未填</span>|
											<span id="car_level">价值：未填</span>
											<span style="border: 1px solid black; border-radius: 20px; background: gainsboro;">
												已认证
											</span>
											<div id="loveCarPhoto">
												<img src="" data-preview-src="" data-preview-group="2" />
												<img src="" data-preview-src="" data-preview-group="2" />
												<img src="" data-preview-src="" data-preview-group="2" />
											</div>
										</div>
									</div>
								</div>
								<div>
									<span style="color: green;" class="mui-pull-right">当已有音频后点击mic录制修改上传</span>
									<h5 class="mui-content-padded">音频认证</h5>

									<div class="card" style=" height: 66px; text-align: center;">
										<button type="button" id="recording" class="mui-icon mui-icon-mic" style=" float: left; margin: 10px 10%;  border: 1px solid gray; border-radius: 90px; padding: 10px;"></button>
										<span style="line-height: 66px;  float: left; ">点击左侧mic录制语音</span>
										<div id="recordShow" style=" visibility: hidden; float: right; text-align: center; height: 66px; width: 25%; ">
											<div>
												<button type="button" id="recordPlay" class="mui-icon mui-icon-mic" style="  border: 1px solid gray; margin-top: 5px; border-radius: 90px; padding: 5px;"></button>
											</div>
											<span style="color: red;">未审核</span>
										</div>
									</div>
								</div>
								<div>
									<span style="color: green;" class="mui-pull-right">当已有视频后点击录制修改上传</span>
									<h5 class="mui-content-padded">视频认证</h5>

									<div class="card" style=" height: 66px; text-align: center;">
										<button type="button" id="ed_video" class="mui-icon mui-icon-videocam" style=" float: left; margin: 10px 10%;  border: 1px solid gray; border-radius: 90px; padding: 10px;"></button>
										<span style="line-height: 66px;  float: left;">点击左侧进行视频认证</span>
										<div id="VideoShow" style=" visibility: hidden; float: right; text-align: center; height: 66px; width: 25%; ">
											<div>
												<button type="button" id="vidoPlay" class="mui-icon mui-icon-mic" style="  border: 1px solid gray; margin-top: 5px; border-radius: 90px; padding: 5px;"></button>
											</div>
											<span style="color: red;">未审核</span>
										</div>
									</div>
								</div>
								<div>
									<h5 class="mui-content-padded">收到的礼物</h5>
									<div class="card">
										<div style="padding: 10px; text-align: center;">
											<img style="width: 50px !important; height: 50px !important ;" src="../../img/travel_2.jpg" />
											<img style="width: 50px !important; height: 50px !important ;" src="../../img/guide_1.jpg" />
											<img style="width: 50px !important; height: 50px !important ;" src="../../img/travel_2.jpg" />
											<img style="width: 50px !important; height: 50px !important ;" src="../../img/guide_1.jpg" />
											<img style="width: 50px !important; height: 50px !important ;" src="../../img/travel_2.jpg" />
										</div>
									</div>
								</div>
								<div>
									<h5 class="mui-content-padded">其他信息</h5>
									<div class="card">

										<ul class="mui-table-view">
											<li class="mui-table-view-cell">
												<span>会员等级</span>
												<span style="float: right; color: blue;">高级会员</span>
											</li>
											<li class="mui-table-view-cell" id="ed_job">
												<span>职业认证</span>
												<span style="float: right; color: blue;">未认证</span>
											</li>
											<li class="mui-table-view-cell">
												<span>Vip信息</span>
												<span style="float: right; color: blue;">Vip3级会员</span>
											</li>
										</ul>
									</div>
								</div>
							</div>
							<div id="item2mobile" class="mui-slider-item mui-control-content">
								<h5 class="mui-content-padded">
								相册
									<span id="upLoadImg" style="float: right; border: 1px solid gainsboro; border-radius: 10px; font-size: 0.9em; padding: 2px 5px;color: white; background-color: green" >
										上传新照片
									</span>
								</h5>
								<div class="photoShow">
									<ul class="mui-table-view mui-grid-view" id="AlbumRoom">
									</ul>
								</div>
							</div>
							<div id="item3mobile" class="mui-slider-item mui-control-content">
								<div class="card" style="margin-top: 10px;">

									<ul class="mui-table-view">
										<li class="mui-table-view-cell">
											<span class="mui-icon mui-icon-flag"></span> 我发起的旅行
										</li>
										<li class="mui-table-view-cell">
											<span class="mui-icon mui-icon-compose"></span> 我报名的旅行
										</li>
										<li class="mui-table-view-cell">
											<span class="mui-icon mui-icon-star"></span> 我收藏的旅行
										</li>
									</ul>
								</div>
							</div>
						</div>
					</div>

				</div>
			</div>
		</div>
	</body>
	<script>
		mui.previewImage();
	</script>

</html>
<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<title></title>
		<script src="../../js/mui.min.js"></script>
		<link href="../../css/mui.min.css" rel="stylesheet" />
		<!--<link rel="stylesheet" type="text/css" href="../../css/header.css"/>-->
		<script type="text/javascript" src="../../js/lvai.data/config.js"></script>
		<script src="../../js/jquery-1.7.2.min.js"></script>
		<script src="../../js/jquery.lazyload.js"></script>
		<script type="text/javascript" src="../../js/lvai.base/JsonTools.js"></script>
		<script type="text/javascript" src="../../js/lvai.op/FileTool.js"></script>
		<script type="text/javascript" src="../../js/lvai.base/Utility.js"></script>
		<script type="text/javascript" src="../../js/lvai.base/localStorageUtils.js"></script>
		<script type="text/javascript" src="../../js/extends/extends.js"></script>
		<script type="text/javascript" src="../../js/lvai.data/UserDAL.js"></script>
		<script type="text/javascript" src="../../js/lvai.data/WebService2.js"></script>
		<style type="text/css">
			/*body{background-color: white;}
			.mui-content{background-color: white;}*/
			
			#selectMenu {
				margin-top: 12px;
			}
			#selectMenu li {
				margin-bottom: 10px;
				background: white;
			}
			#selectMenu ul {
				background-color: #EEEEEE
			}
			.mui-control-content {
				min-height: 350px;
			}
			.mui-control-content .mui-loading {
				margin-top: 50px;
			}
			.card {
				background-color: white;
			}
			.photoShow {} .photoShow img {
				float: left;
				margin: 10px;
				width: 100px !important;
				height: 100px !important;
			}
			/*.rp {
				width: 100%;
				height: 100%;
				display: none;
				text-align: center;
				position: fixed;
				top: 0;
				background: rgba(0,0,0,0.8);
				z-index: 9999;
				overflow: hidden;
			}*/
		</style>
		<script type="text/javascript" charset="utf-8">
			var listCar;
			var listCarWidth;
			var carPhoto = new Array(); //车辆地址存放
			var photoindex = 0;
			var carPhotoState = 3;
			var editor;
			var ed_car;
			var ed_video;
			var ed_job;
			var record = null,
				t = null,
				iv = null,
				w = null;
			mui.init({
				gestureConfig: {
					hold: true, //默认为false，不监听
					release: true //默认为false，不监听
				}
			});
			 // 扩展API加载完毕后调用onPlusReady回调函数 
			document.addEventListener("plusready", onPlusReady);
			 // 扩展API加载完毕，现在可以正常调用扩展API 
			function onPlusReady() {
				listCarWidth = plus.webview.currentWebview().listCarWidth;
				record = plus.audio.getRecorder();
				setPageUi();
				DataShow();
				loadAsynchronou();
			};
			 //设置页面Ui
			function setPageUi() {
				systemUi();
				CarPhotoUi();
			};
			 // 系统Ui
			function systemUi() {
				//减速系数
				mui('.mui-scroll-wrapper').scroll({
					deceleration: 0.0005 //减速系数，系数越大，滚动速度越慢，滚动距离越小，默认值0.0006
				});
				//去除滚动条
				mui('#scroll').scroll({
					indicators: false
				});
			};
			 //车辆图片Ui
			function CarPhotoUi() {
				listCar = document.querySelector("#loveCarPhoto");
				var carPhotoImg = listCar.getElementsByTagName('img');
				for (var car_index = 0; car_index < carPhotoImg.length; car_index++) {
					carPhotoImg[car_index].style.width = listCarWidth * 0.3 + "px";
					carPhotoImg[car_index].style.height = listCarWidth * 0.3 + "px";
					carPhotoImg[car_index].style.margin = "3px 6px";
					carPhotoImg[car_index].className = "lazy";
					carPhotoImg[car_index].style.float = "left";
					carPhotoImg[car_index].style.display = "none";
				}
			};
			 //数据展示
			function DataShow() {
				DataHeadPhotoShow(DataInfoShow());
				DataCarShow();
			};
			 //基本信息的判断及展示
			function DataInfoShow() {
				var userInfoTxt = new localStorageUtils().getItem("userInfo");
				var userInfo = new JsonTools().stringToJson(userInfoTxt);
				//找到登录时   在服务器  获取到的 用户信息
				document.querySelector("#txtName").innerHTML = userInfo.user_nikeName;
				document.querySelector("#user_height").innerHTML = userInfo.user_height;
				document.querySelector("#user_weight").innerHTML = userInfo.user_weight;
				document.querySelector("#user_income").innerHTML = userInfo.user_income;
				document.querySelector("#user_address").innerHTML = userInfo.user_address;
				document.querySelector("#user_job").innerHTML = userInfo.user_job;
				var Newtime = new Date();
				document.querySelector("#user_age").innerHTML = Newtime.getFullYear() - new Date(userInfo.user_birthday).getFullYear() + 1 + "岁";
				return userInfo;
			};
			 //头像的判断及展示
			function DataHeadPhotoShow(userInfo) {
				var url = "_doc/HeadPhoto/" + userInfo.user_photo.substring(userInfo.user_photo.lastIndexOf('/') + 1);
				fileTool.fileExist(url, userInfo.user_photo,
					function(msg) {
						ShowHead(msg);
					},
					function(msg, _args) {
						//文件不存在则下载
						fileTool.fileDown(ResourcesServerUrl + _args, 1, function() {
							ShowHead(msg);
						});
					}
				);
			};
			 //显示头像
			function ShowHead(url) {
				//document.querySelector("#editor").removeAttribute("src");
				document.querySelector("#editor").setAttribute("src", plus.io.convertLocalFileSystemURL(url));
				//$("img.lazy").lazyload();
			};
			 //车辆信息的判断及展示
			function DataCarShow() {
				var userCarTxt = new localStorageUtils().getItem("userCar");
				var car = new JsonTools().stringToJson(userCarTxt)["data"];
				document.querySelector("#car_brand").innerHTML = car.car_brand;
				document.querySelector("#car_level").innerHTML = car.car_level;
				document.querySelector("#car_type").innerHTML = car.car_type;
				carPhoto[0] = car.car_photo1;
				carPhoto[1] = car.car_photo2;
				carPhoto[2] = car.car_photo3;
				for (var index = 0; index < carPhoto.length; index++) {
					if (carPhoto[index] != "") {
						listCar.style.height = listCarWidth * 0.3 + 6 + "px";
						break;
					}
				}
			};
			 //异步加载车辆图片及下载数据
			function loadAsynchronou() {
				setTimeout(function() {
					loadCarPhoto();
				}, 100);
			};
			 //载入车辆图片
			function loadCarPhoto() {
				photoindex = 0;
				carPhotoState = 3;
				for (var index = 0; index < carPhoto.length; index++) {
					if (carPhoto[index] == "") {
						carPhotoState--;
						if (carPhotoState == 0) {
							OnPreload();
							MenuInit();
							webListener();
						}
						continue;
					}
					var url = "_doc/CarPhoto/thumbCarPhoto/" + carPhoto[index].substring(carPhoto[index].lastIndexOf('/') + 1);
					fileTool.fileExist(url, carPhoto[index], function(msg) {
						//文件存在跳过下载显示
						carPhotoState--;
						photoindex++;
						if (carPhotoState == 0) {
							LoveCarShow();
						}
					}, function(msg, _args) {
						//文件不存在下载再显示
						fileTool.fileDown(ResourcesServerUrl + _args, 3, function() {
							//下载完成后显示
							carPhotoState--;
							photoindex++;
							if (carPhotoState == 0) {
								loadCarPhoto();
							}
						});
					});
				}
			};
			 //显示车辆图片
			function LoveCarShow() {
				for (; carPhotoState < photoindex; carPhotoState++) {
					AddLoveCar(carPhotoState + 1);
				}
				OnPreload();
				MenuInit();
				webListener();
				//$("img.lazy").lazyload();
			};
			 //添加车辆图片
			function AddLoveCar(indexs) {
				var url = "_doc/CarPhoto/thumbCarPhoto/" + carPhoto[indexs - 1].substring(carPhoto[indexs - 1].lastIndexOf('/') + 1);
				var carPhotoImg = listCar.getElementsByTagName('img');
				carPhotoImg[indexs - 1].setAttribute("src", plus.io.convertLocalFileSystemURL(url));
				carPhotoImg[indexs - 1].style.display = "block";
			};
			 //预加载
			function OnPreload() {
				editor = mui.preload({
					"id": 'editor',
					"url": 'editor_card1.html'
				});
				ed_car = mui.preload({
					"id": 'ed_car',
					"url": 'editor_car.html'
				});
				ed_video = mui.preload({
					"id": 'ed_video',
					"url": 'editor_video.html'
				});
				ed_job = mui.preload({
					"id": 'ed_job',
					"url": 'editor_job.html'
				});
			};
			 //按钮的监听事件
			function MenuInit() {
				//头像按钮
				document.getElementById('editor').addEventListener('tap', function() {
					var btnArray = [{
						title: "拍照"
					}, {
						title: "选取现有的"
					}];
					plus.nativeUI.actionSheet({
						//title: "头像选取方式",  
						cancel: "取消",
						buttons: btnArray
					}, function(e) {
						var index = e.index;
						switch (index) {
							case 0:
								{
									//plus.ui.alert("你选择了取消", "警告", "OK");
									break;
								}
							case 1:
								{
									//plus.ui.alert("你选择了拍照", "警告", "OK");							
									var cmr = plus.camera.getCamera();
									var res = cmr.supportedImageResolutions[0];
									var fmt = cmr.supportedImageFormats[0];
									cmr.captureImage(function(path) {
											//alert(plus.io.convertLocalFileSystemURL(path));
											plus.storage.setItem("Icon", plus.io.convertLocalFileSystemURL(path));
											console.log(plus.storage.getItem("Icon"));
											var wvphone = mui.openWindow({
												url: 'editor_photo.html',
												id: 'Icon',
												show: {
													aniShow: 'fade-in'
												}
											});
											wvphone.addEventListener("close", function() {
												console.log("裁剪窗口以关闭");
												var base64 = new localStorageUtils().getItem("HeadPhotoBase64");
												if (base64 != "") {
													document.querySelector("#editor").setAttribute("src", base64);
												}
											});
											//document.querySelector("#user_photo>img").setAttribute('src', plus.io.convertLocalFileSystemURL(path));
										},
										function(error) {
											alert("Capture image failed: " + error.message);
										}, {
											resolution: res,
											format: fmt
										}
									);
									break;
								}
							case 2:
								{
									//plus.ui.alert("你选择了选取现有的", "警告", "OK");	
									plus.gallery.pick(function(path) {
										plus.storage.setItem("Icon", plus.io.convertLocalFileSystemURL(path));
										console.log(plus.storage.getItem("Icon"));
										var wvphone = mui.openWindow({
											url: 'editor_photo.html',
											id: 'Icon',
											show: {
												aniShow: 'fade-in'
											}
										});
										wvphone.addEventListener("close", function() {
											console.log("裁剪窗口以关闭");
											var base64 = new localStorageUtils().getItem("HeadPhotoBase64");
											if (base64 != "") {
												document.querySelector("#editor").setAttribute("src", base64);
											}
										});
									}, function(e) {}, {
										filter: "image"
									});
									break;
								}
						}
					});
				});
				//基本信息按钮
				document.getElementById('ed').addEventListener('tap', function() {
					mui.fire(editor, 'show', null);
					setTimeout(function() {
						mui.openWindow({
							id: 'editor',
							show: {
								aniShow: 'pop-in'
							},
							waiting: {
								autoShow: false
							},
							styles: {
								zindex: 600
							}
						});
					}, 0);
				});
				//录制语音hold
				document.getElementById("recording").addEventListener('tap', function() {
					if (record == null) {
						alert("麦克风未就绪！");
						return;
					}
					var thisr = this;
					record.record({
						filename: "_doc/audio/"
					}, function(p) {
						plus.io.resolveLocalFileSystemURL(p, function(entry) {
							var confirm = function() {
								// 弹出提示信息对话框	entry.name
								plus.nativeUI.confirm(entry.name, function(e) {
									switch (e.index) {
										case 0:
											break; //上传
										case 1:
											break; //取消
										case 2:
											var ww = plus.nativeUI.showWaiting("试听中... ", {
												background: "rgba(56,12,92,0.8)",
												back: "none"
											});
											var play = plus.audio.createPlayer(p);
											play.play(function() {
												confirm();
												ww.close();
											});
											break;
											//									default:mui.toast("fail");break;
									}
								}, "是否上传该录音?", ["上传", "取消", "试听"]);
							}
							confirm();
						}, function(e) {
							mui.toast("读取录音文件错误");
						});
					}, function(e) {
						mui.toast("录音失败");
					});
					w = plus.nativeUI.showWaiting("开始录制 ", {
						padding: '6%',
						background: "rgba(10,92,19,0.7)",
						back: "none"
					});
					t = 0;
					iv = setInterval(function() {
						t++;
						if (t >= 5) {
							//							mui.trigger(thisr,'release');
							w.close();
							clearInterval(iv);
							record.stop();
							return;
						}
						w.setTitle("剩余:" + (5 - t) + "秒");
					}, 1000);
				});
				//车辆信息按钮
				document.getElementById("ed_car").addEventListener('tap', function() {
					mui.fire(ed_car, 'show', null);
					setTimeout(function() {
						mui.openWindow({
							id: 'ed_car',
							show: {
								aniShow: 'zoom-fade-out',
								duration: 300
							},
							waiting: {
								autoShow: false
							},
							styles: {
								zindex: 600
							}
						});
					}, 0);
				});
				//视屏认证按钮
				document.getElementById("ed_video").addEventListener('tap', function() {
					mui.fire(ed_video, 'show', null);
					setTimeout(function() {
						mui.openWindow({
							id: 'ed_video',
							show: {
								aniShow: 'pop-in'
							},
							waiting: {
								autoShow: false
							},
							styles: {
								zindex: 600
							}
						});
					}, 0);
				});
				//职业认证
				document.getElementById("ed_job").addEventListener('tap', function() {
					mui.fire(ed_video, 'show', null);
					setTimeout(function() {
						mui.openWindow({
							id: 'ed_job',
							show: {
								aniShow: 'pop-in'
							},
							waiting: {
								autoShow: false
							},
							styles: {
								zindex: 600
							}
						});
					}, 0);
				});
			};
			 //webview的监听
			function webListener() {
				plus.webview.getWebviewById("editor").addEventListener("hide", function() {
					console.log("个人资料编辑窗口以关闭");
					DataInfoShow();
				});
				plus.webview.getWebviewById("ed_car").addEventListener("hide", function() {
					console.log("车辆编辑窗口以关闭");
					DataCarShow();
				});
				window.addEventListener("CarPhoto:Change", ChangeCarPhoto);
			};
			 //车辆子页面发生改变时所执行的函数
			function ChangeCarPhoto() {
				var userCarTxt = new localStorageUtils().getItem("userCar");
				var car = new JsonTools().stringToJson(userCarTxt)["data"];
				carPhoto[0] = car.car_photo1;
				carPhoto[1] = car.car_photo2;
				carPhoto[2] = car.car_photo3;
				for (var index = 0; index < carPhoto.length; index++) {
					if (carPhoto[index] != "") {
						listCar.style.height = listCarWidth * 0.3 + 6 + "px";
						break;
					}
				}
				loadAsynchronou();
			}
		</script>
	</head>

	<body>
		<header class="mui-bar mui-bar-nav" hidden="ture">
			<h1 class="mui-title">乐小姐</h1>
		</header>

		<div class="mui-content" style="background: #FFF;">

			<div id="scroll" class="mui-scroll-wrapper">
				<div class="mui-scroll">
					<div style="text-align: center; margin-bottom: -38px;padding-bottom: 58px; background: no-repeat url(../../img/login_Log.jpg)">
						<div style="height: 44px;">
							<span style="text-align: center;line-height: 44px;">个人中心</span>
						</div>
						<img id="editor" class="lazy" style="line-height: 50px; background-color: transparent; border: 1px solid #ddd;
  border-radius: 50px;" src="../../img/travel_2.jpg" width="70px" height="70px">
						<div>
							<span id="txtName">神秘爱称</span>
							<div>
								<img src="../../img/guide_1.jpg" width="10px" height="10px" />
								<img src="../../img/guide_1.jpg" width="10px" height="10px" />
								<img src="../../img/guide_1.jpg" width="10px" height="10px" />
							</div>
						</div>

					</div>

					<div id="slider" class="mui-slider">
						<div id="sliderSegmentedControl" class="mui-slider-indicator mui-segmented-control mui-segmented-control-inverted" style="background-color: transparent !important;">
							<a class="mui-control-item" href="#item1mobile">
						资料 
					</a>
							<a class="mui-control-item" href="#item2mobile">
						照片
					</a>
							<a class="mui-control-item" href="#item3mobile">
						旅行
					</a>
						</div>
						<div id="sliderProgressBar" class="mui-slider-progress-bar mui-col-xs-4"></div>

						<div class="mui-slider-group">

							<div id="item1mobile" style="background-color:gainsboro" class="mui-slider-item mui-control-content mui-active">

								<div>
									<span id='ed' class="mui-icon mui-icon-compose mui-pull-right" style="line-height:12px;padding: 1px; margin-right: 8px;"></span>
									<h5 class="mui-content-padded">基本信息</h5>
									<div class="card">
										<div style="background: white; text-align: center;">
											<span id="user_age">XX岁</span>|
											<span id="user_height">XXcm~XXcm</span>|
											<span id="user_weight">XXkg</span>|
											<span id="user_income">年入XX万</span>|
											<br />
											<span id="user_address">XX省-XX市</span>|
											<span>单身</span>|
											<span id="user_job">XX职业</span>
										</div>

										<div style="text-align:center">
											<!--<span class="mui-icon mui-icon-mic" style=" border: 1px solid gray; border-radius: 90px; padding: 10px;"></span>-->
											<button type="button" id="recording" class="mui-icon mui-icon-mic" style=" border: 1px solid gray; border-radius: 90px; padding: 10px;"></button>
											<span style="line-height: 50px;">点击左侧mic录制语音</span>

										</div>

									</div>
								</div>

								<div>
									<span id='ed_car' class="mui-icon mui-icon-compose mui-pull-right" style=" line-height:12px; padding: 1px;margin-right: 8px;"></span>
									<h5 class="mui-content-padded">车辆信息</h5>
									<div class="card">
										<div style="background: white; text-align: center;">
											<span id="car_brand">XX车</span>|
											<span id="car_type">XX级别</span>|
											<span id="car_level">价值XX万</span>
											<span style="border: 1px solid black; border-radius: 20px; background: gainsboro;">
												已认证
											</span>
											<div id="loveCarPhoto">
												<img src="" />
												<img src="" />
												<img src="" />
											</div>
										</div>
									</div>
								</div>

								<div>
									<h5 class="mui-content-padded">视频认证</h5>
									<div class="card" style="padding: 20px 0;text-align: center;">
										<span class="mui-icon mui-icon-videocam" style="border: 1px solid gray; border-radius: 90px; padding: 10px;"></span>
										<span id="ed_video"><a>点击进行视频认证</a></span>
									</div>
								</div>

								<div>
									<h5 class="mui-content-padded">收到的礼物</h5>
									<div class="card">
										<div style="padding: 10px; text-align: center;">
											<img style="width: 50px !important; height: 50px !important ;" src="../../img/travel_2.jpg" />
											<img style="width: 50px !important; height: 50px !important ;" src="../../img/guide_1.jpg" />
											<img style="width: 50px !important; height: 50px !important ;" src="../../img/travel_2.jpg" />
											<img style="width: 50px !important; height: 50px !important ;" src="../../img/guide_1.jpg" />
											<img style="width: 50px !important; height: 50px !important ;" src="../../img/travel_2.jpg" />
										</div>
									</div>
								</div>

								<div>
									<h5 class="mui-content-padded">其他信息</h5>
									<div class="card">

										<ul class="mui-table-view">
											<li class="mui-table-view-cell">
												<span>会员等级</span>
												<span style="float: right; color: blue;">高级会员</span>
											</li>
											<li class="mui-table-view-cell" id="ed_job">
												<span>职业认证</span>
												<span style="float: right; color: blue;">未认证</span>
											</li>
											<li class="mui-table-view-cell">
												<span>Vip信息</span>
												<span style="float: right; color: blue;">Vip3级会员</span>
											</li>
										</ul>

									</div>
								</div>

							</div>

							<div id="item2mobile" class="mui-slider-item mui-control-content">
								<h5 class="mui-content-padded">
								32张相片
									<span style="float: right; border: 1px solid gainsboro; border-radius: 10px; font-size: 0.9em; padding: 2px 5px;color: white; background-color: green" >
										上传新照片
									</span>
								</h5>
								<hr />
								<div class="photoShow">
									<img src="../../img/guide_1.jpg" />
									<img src="../../img/travel_2.jpg" />
									<img src="../../img/travel_2.jpg" />
									<img src="../../img/travel_2.jpg" />
									<img src="../../img/travel_2.jpg" />
									<img src="../../img/travel_2.jpg" />
									<img src="../../img/travel_2.jpg" />
									<img src="../../img/travel_2.jpg" />
									<img src="../../img/travel_2.jpg" />
									<img src="../../img/travel_2.jpg" />
									<img src="../../img/travel_2.jpg" />
									<img src="../../img/travel_2.jpg" />
									<img src="../../img/travel_2.jpg" />
								</div>

								<!--</div>
						</div>-->

							</div>

							<div id="item3mobile" class="mui-slider-item mui-control-content">
								<div class="card" style="margin-top: 10px;">

									<ul class="mui-table-view">
										<li class="mui-table-view-cell">
											<span class="mui-icon mui-icon-flag"></span> 我发起的旅行

										</li>
										<li class="mui-table-view-cell">
											<span class="mui-icon mui-icon-compose"></span> 我报名的旅行

										</li>
										<li class="mui-table-view-cell">
											<span class="mui-icon mui-icon-star"></span> 我收藏的旅行

										</li>
									</ul>

								</div>
							</div>

						</div>
					</div>

				</div>
			</div>
		</div>
	</body>
	<script>
		 //$("img.lazy").lazyload();
	</script>

</html>